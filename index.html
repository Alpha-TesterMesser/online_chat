<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Chat â€” Enter username</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="./style.css" />
  <style>
    body{font-family:system-ui,Arial;margin:0;display:flex;min-height:100vh;align-items:center;justify-content:center;background:#f4f6f8}
    .card{background:#fff;padding:20px;border-radius:10px;box-shadow:0 8px 30px rgba(2,6,23,0.06);max-width:520px;width:100%}
    label{display:block;margin-top:8px}
    input{width:100%;padding:8px;border-radius:8px;border:1px solid #e6e7ea}
    .row{margin-top:12px;display:flex;gap:8px}
    button{background:#0b5fff;color:#fff;border:0;padding:9px 12px;border-radius:8px;cursor:pointer}
    .muted{color:#6b7280;font-size:13px;margin-top:8px}
  </style><header style="display:flex; justify-content:space-between; align-items:center;">
  <div>
    <h1>Main</h1>
    <div id="meLine" class="muted"></div>
  </div>
  <div style="display:flex; gap:8px; align-items:center;">
    <button id="themeToggle" class="secondary" aria-pressed="false" title="Toggle theme">
      ðŸŒ™ Dark
    </button>
  </div>
</header>
</head>

<body>
  <main class="card" role="main">
    <h1>Welcome</h1>
    <p class="muted">Enter a username to start. The chat UI will open in a new tab (about:blank) and then load the app.</p>

    <label>
      Username
      <input id="usernameInput" type="text" maxlength="50" placeholder="e.g. Alice" />
    </label>

    <div class="row">
      <button id="enterBtn">Enter Chat</button>
    </div>

    <small class="muted">Username is kept while this tab is open and cleared when the tab closes.</small>
  </main>

  <script>
    // remove username when the current tab is closed
    window.addEventListener('beforeunload', () => {
      try { localStorage.removeItem('username'); } catch (e) {}
    });

    // helper to open about:blank, write a placeholder, then navigate
    function openBlankThenNavigate(relativePath) {
      // Open an empty (blank) window. Must be directly in a click handler to avoid popup blocking.
      let w = null;
      try {
        w = window.open('about:blank', '_blank');

        // If we got a window reference, write a small placeholder to it so user actually sees something.
        if (w && w.document) {
          const html = `
            <!doctype html><html><head><meta charset="utf-8"><title>Loadingâ€¦</title>
            <meta name="viewport" content="width=device-width,initial-scale=1">
            <style>body{font-family:system-ui,Arial,Helvetica,sans-serif;display:flex;align-items:center;justify-content:center;height:100vh;margin:0;background:#111;color:#fff} .box{padding:20px;border-radius:10px;background:rgba(255,255,255,0.06);text-align:center} .muted{opacity:0.9;font-size:14px}</style>
            </head><body><div class="box"><div style="font-size:18px">Preparing chatâ€¦</div><div class="muted" style="margin-top:8px">${location.pathname.replace(/\\/g,'/')}</div></div></body></html>
          `;
          // write placeholder synchronously
          w.document.open();
          w.document.write(html);
          w.document.close();
        }

        // After a short tick, navigate the new window to the real page (relative path)
        // we use setTimeout to make sure the placeholder paints
        setTimeout(() => {
          try {
            // Use a relative path so project-site subpaths work (./join.html resolves to repo subpath)
            w.location = relativePath;
          } catch (err) {
            // If navigation is blocked for some reason, do a fallback to opening directly
            try { window.open(relativePath, '_blank'); } catch(e){}
          }
        }, 60); // tiny delay so the placeholder is visible briefly
        return true;
      } catch (err) {
        // Could not open a new window (popup blocked)
        console.warn('openBlankThenNavigate failed', err);
        return false;
      }
    }

    // If username already set in this tab, auto-open the join page (use a click-like flow)
    (function autoOpenIfSet(){
      try {
        if (localStorage.getItem('username')) {
          // try to open about:blank then navigate; if blocked, open the target directly
          const ok = openBlankThenNavigate('./join.html');
          if (!ok) window.open('./join.html', '_blank');
        }
      } catch(e){}
    })();

    document.getElementById('enterBtn').addEventListener('click', () => {
      const v = document.getElementById('usernameInput').value.trim();
      if (!v) return alert('Please enter a username');
      localStorage.setItem('username', v);

      // Attempt to open blank then navigate
      const success = openBlankThenNavigate('./join.html');
      if (!success) {
        // Fallback: directly open join.html (some popup blockers)
        window.open('./join.html', '_blank');
      }

      // disable inputs in this tab to prevent changes here
      document.getElementById('usernameInput').disabled = true;
      document.getElementById('enterBtn').disabled = true;
    });

    // allow Enter key to trigger
    document.getElementById('usernameInput').addEventListener('keydown', (e) => { if (e.key === 'Enter') document.getElementById('enterBtn').click(); });
  </script>
</body>
</html>


