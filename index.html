<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Chat â€” Enter username</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:system-ui,Arial;margin:0;display:flex;min-height:100vh;align-items:center;justify-content:center;background:#f4f6f8}
    .card{background:#fff;padding:20px;border-radius:10px;box-shadow:0 8px 30px rgba(2,6,23,0.06);max-width:540px;width:100%}
    label{display:block;margin-top:8px}
    input{width:100%;padding:8px;border-radius:8px;border:1px solid #e6e7ea}
    .row{margin-top:12px;display:flex;gap:8px}
    button{background:#0b5fff;color:#fff;border:0;padding:9px 12px;border-radius:8px;cursor:pointer}
    .muted{color:#6b7280;font-size:13px;margin-top:8px}
    .hint{margin-top:12px;color:#444;font-size:13px}
  </style>
  <header style="display:flex; justify-content:space-between; align-items:center;">
  <div>
    <h1>Main</h1>
    <div id="meLine" class="muted"></div>
  </div>
  <div style="display:flex; gap:8px; align-items:center;">
    <button id="themeToggle" class="secondary" aria-pressed="false" title="Toggle theme">
      ðŸŒ™ Dark
    </button>
  </div>
</header>
</head>

<body>
  <main class="card" role="main" aria-live="polite">
    <h1>Welcome</h1>
    <p class="muted">Enter a username â€” a new about:blank tab will open and host the app inside an iframe (the address bar will show <code>about:blank</code>).</p>

    <label>
      Username
      <input id="usernameInput" type="text" maxlength="50" placeholder="e.g. Alice" />
    </label>

    <div class="row">
      <button id="enterBtn">Enter</button>
    </div>

    <div id="closeHint" class="hint" style="display:none;">
      If the original tab is still open, you can safely close it now.
    </div>

    <small class="muted">If popups are blocked we fall back to opening the app in this tab.</small>
  </main>

  <script>
    const TARGET_RELATIVE = './join.html';

    function escapeHtml(s=''){ return String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

    function buildAboutBlankWithIframe(username, absoluteTarget) {
      const safe = escapeHtml(username || '');
      return `<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>about:blank</title>
    <style>
      html,body{height:100%;margin:0;background:#fff}
      iframe{position:fixed;inset:0;border:0;width:100%;height:100%}
    </style>
  </head>
  <body>
    <iframe id="appFrame" src="${absoluteTarget}" allow="clipboard-write"></iframe>
    <script>
      (function(){
        const f = document.getElementById('appFrame');
        f && f.addEventListener('load', () => {
          try { f.contentWindow && f.contentWindow.focus(); } catch(e) {}
        });
      })();
    <\/script>
  </body>
</html>`;
    }

    function computeAbsoluteTarget() {
      return new URL(TARGET_RELATIVE, location.href).href;
    }

    function openAboutBlankWithIframe(username) {
      const abs = computeAbsoluteTarget();
      let w = null;
      try { w = window.open('about:blank', '_blank'); } catch(e) { w = null; }
      if (!w) return false;
      try {
        const html = buildAboutBlankWithIframe(username, abs);
        w.document.open();
        w.document.write(html);
        w.document.close();
        try { w.focus(); } catch(e) {}
        return true;
      } catch(err) {
        try { w.close(); } catch(e){}
        return false;
      }
    }

    function fallbackReplaceCurrent(username) {
      const abs = computeAbsoluteTarget();
      const safe = escapeHtml(username || '');
      const html = `<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<style>html,body{height:100%;margin:0;background:#fff;font-family:system-ui,Arial}</style></head><body>
  <div style="display:flex;align-items:center;justify-content:center;height:100%">
    <div style="text-align:center">
      <div style="font-size:16px">Preparing chatâ€¦</div>
      <div style="color:#444;margin-top:8px">${safe? 'User: '+safe : ''}</div>
    </div>
  </div>
  <script>setTimeout(function(){ location.href = '${abs}'; }, 120);<\/script>
</body></html>`;
      document.open();
      document.write(html);
      document.close();
    }

    function tryToCloseOriginalTab() {
      try { window.close(); } catch(e){}
      setTimeout(() => {
        if (!window.closed) document.getElementById('closeHint').style.display = 'block';
      }, 300);
    }

    document.getElementById('enterBtn').addEventListener('click', () => {
      const name = document.getElementById('usernameInput').value.trim();
      if (!name) return alert('Please enter a username');
      try { localStorage.setItem('username', name); } catch(e){}
      const ok = openAboutBlankWithIframe(name);
      if (!ok) { fallbackReplaceCurrent(name); return; }
      tryToCloseOriginalTab();
    });

    (function autoOpenIfSet() {
      try {
        const existing = localStorage.getItem('username');
        if (!existing) return;
        const ok = openAboutBlankWithIframe(existing);
        if (!ok) fallbackReplaceCurrent(existing);
        else tryToCloseOriginalTab();
      } catch(e){}
    })();
  </script>
</body>
</html>


